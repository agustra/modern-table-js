<!DOCTYPE html>
<!-- <html lang="en"> -->
<html lang="id" translate="no" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test: Advanced Features</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    /> -->

    <link href="/modern-table.css" rel="stylesheet" />
    <!-- <link href="/responsive.css" rel="stylesheet" /> -->
    <link href="responsive-columns.css" rel="stylesheet" />

    <link href="/themes.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container mt-4">
      <h2>ðŸš€ Test: Advanced Features</h2>
      <p class="text-muted">
        Testing advanced parameter transformation with sorting, search, and data
        preprocessing
      </p>

      <div class="card col-md-12">
        <div class="card-header">
          <h5>Users Table (Advanced Features)</h5>
        </div>
        <div class="card-body">
          <table
            id="advanced-table"
            class="table table-striped table-hover"
          ></table>
        </div>
      </div>
    </div>

    <script type="module">
      // import { ModernTable } from "https://cdn.jsdelivr.net/npm/modern-table-js@1.0.10/core/ModernTable.js";

      import { ModernTable } from "/core/ModernTable.js";

      const table = new ModernTable("#advanced-table", {
        api: {
          url: "https://dummyjson.com/users",
          method: "GET",

          beforeRequest: async (config) => {
            // console.group("ðŸ”„ Parameter Transformation");
            // console.log("ðŸ“¤ Original params:", config.data);

            const params = config.data || {};
            const query = new URLSearchParams();

            // Basic pagination
            query.append("limit", params.length || 10);
            query.append("skip", params.start || 0);

            // Global search
            if (params.search?.value) {
              query.append("q", params.search.value);
            }

            // Sorting (DummyJSON supports sortBy and order)
            if (params.order?.length > 0) {
              const order = params.order[0];
              const column = params.columns[order.column];
              query.append("sortBy", column.data);
              query.append("order", order.dir);
            }

            config.url = `https://dummyjson.com/users?${query.toString()}`;
            // console.log("ðŸŒ Final URL:", config.url);
            // console.groupEnd();

            return config;
          },

          dataSrc: function (json) {
            // console.group("ðŸ“¥ Response Transformation");
            // console.log("ðŸ“Š Raw response:", json);

            // Preprocess data before rendering
            const processedData = json.users.map((user) => ({
              ...user,
              fullName: `${user.firstName} ${user.lastName}`,
              avatar: user.image || "/default-avatar.png",
              status: user.age >= 18 ? "Adult" : "Minor",
              ageGroup:
                user.age < 25 ? "Young" : user.age < 50 ? "Middle" : "Senior",
            }));

            const result = {
              draw: json.draw || 1,
              recordsTotal: json.total,
              recordsFiltered: json.total,
              data: processedData,
            };

            // console.log("âœ… Transformed result:", result);
            // console.groupEnd();

            return result;
          },
        },
        columns: [
          { data: "id", title: "ID" },
          { data: "fullName", title: "Full Name" },
          { data: "email", title: "Email" },
          { data: "age", title: "Age" },
          { data: "ageGroup", title: "Age Group" },
          { data: "status", title: "Status" },
          {
            data: "avatar",
            title: "Avatar",
            // width: "80px",
            render: function (data, type, row) {
              return `<img src="${data}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%;">`;
            },
          },
        ],
        buttons: [
          {
            text: "Create",
            className: "btn btn-primary btn-sm btn-create",
            enabled: false,
            attr: {
              id: "btn-create",
            },
            action: function (e, dt, node, config) {
              alert("Create New Data");
            },
          },
          "copy",
          "csv",
          {
            extend: "pdf",
            text: "PDF",
            className: "btn btn-danger btn-sm btn-pdf",
            filename: "Users",
            orientation: "landscape",
            pageSize: "A4",
            exportColumns: ["avatar_url", "name", "email"],
            titleAttr: "Export data as PDF file",
          },
          {
            extend: "print",
            text: "Print",
            className: "btn btn-warning btn-sm btn-print",
            orientation: "portrait",
            exportColumns: ["avatar_url", "name", "email"],
            titleAttr: "Print selected columns with custom styling",
          },
          "colvis",
        ],
        filters: [
          {
            column: "status",
            type: "select",
            label: "Status",
            className: "btn-sm",
            options: [
              { value: "", text: "All Status" },
              { value: "active", text: "Active" },
              { value: "inactive", text: "Inactive" },
            ],
          },
          {
            column: "name",
            type: "text",
            label: "Name",
            placeholder: "Search by name...",
          },
          {
            column: "created_at",
            type: "date",
            label: "Created Date",
            placeholder: "Select date",
          },
          {
            column: "created_at",
            type: "daterange",
            label: "Date Range",
            placeholder: "Select date",
          },
          {
            type: "clear",
            label: "Clear All",
            className: "btn btn-outline-secondary btn-sm",
          },
        ],

        serverSide: true,
        select: true,
        pageLength: 10,
        paging: true,
        searching: true,
        columnSearch: false,
        ordering: true,
        responsive: true,
        theme: "auto",
      });
    </script>
  </body>
</html>
